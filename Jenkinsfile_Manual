// Jenkinsfile_Manual (para el pipeline regular 'CD_deploy_manual')

pipeline {
    agent any
    
    parameters {
        string(name: 'BRANCH_TO_DEPLOY', defaultValue: 'main', description: 'Selecciona la rama a desplegar: main o dev')
    }

    // Variables globales
    environment {
        APP_PORT = (params.BRANCH_TO_DEPLOY == 'main') ? '3000' : '3001'
        IMAGE_NAME = (params.BRANCH_TO_DEPLOY == 'main') ? 'nodemain:v1.0' : 'nodedev:v1.0'
    }

    stages {
        // Etapa de Despliegue Manual
        stage('Manual Deployment') {
            steps {
                echo "Despliegue manual activado para la rama: ${params.BRANCH_TO_DEPLOY}"
                
                // 1. Asegurarse de tener la imagen (pull de la imagen que el CICD creó localmente)
                // Nota: En un entorno de producción, aquí se haría un 'docker pull' de un registro.
                // Como las imágenes se construyeron localmente, asumimos que están disponibles o las volvemos a construir
                // Para mantener la simplicidad del laboratorio, usamos la que se construyó en el otro pipeline.
                
                // 2. Eliminar contenedores viejos
                sh "docker rm -f app-manual-${params.BRANCH_TO_DEPLOY} || true"
                
                // 3. Desplegar el nuevo contenedor
                sh "docker run -d --name app-manual-${params.BRANCH_TO_DEPLOY} -p ${APP_PORT}:3000 ${IMAGE_NAME}"
                
                echo "Aplicación desplegada manualmente en http://localhost:${APP_PORT}"
            }
        }
    }
}