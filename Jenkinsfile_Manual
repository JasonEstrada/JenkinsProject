// Jenkinsfile_Manual (corregido)

pipeline {
    agent any
    
    parameters {
        string(name: 'BRANCH_TO_DEPLOY', defaultValue: 'main', description: 'Selecciona la rama a desplegar: main o dev')
    }

    // AÑADIR DOCKER_REGISTRY A LA ETAPA MANUAL
    environment {
        DOCKER_REGISTRY = '13102003' // <--- AÑADE ESTO
    }

    stages {
        stage('Manual Deployment') {
            steps {
                script {
                    echo "Despliegue manual activado para la rama: ${params.BRANCH_TO_DEPLOY}"
                    
                    // 1. Definir variables
                    def appPort = (params.BRANCH_TO_DEPLOY == 'main') ? '3000' : '3001'
                    
                    // 2. CONSTRUIR EL NOMBRE COMPLETO DE LA IMAGEN (incluyendo el registro/usuario)
                    def imageTag = (params.BRANCH_TO_DEPLOY == 'main') ? 'nodemain:v1.0' : 'nodedev:v1.0'
                    def fullImageName = "${env.DOCKER_REGISTRY}/${imageTag}" // <--- USAR DOCKER_REGISTRY
                    
                    echo "Intentando desplegar ${fullImageName} en el puerto ${appPort}:3000"
                    
                    // 3. Eliminar contenedores viejos
                    def containerName = "app-manual-${params.BRANCH_TO_DEPLOY}"
                    bat "docker rm -f ${containerName} || true"

                    // 4. Desplegar el nuevo contenedor (usando fullImageName)
                    bat "docker run -d --name ${containerName} -p ${appPort}:3000 ${fullImageName}" // <--- USAR fullImageName
                    
                    echo "Aplicación desplegada manualmente en http://localhost:${appPort}"
                }
            }
        }
    }
}