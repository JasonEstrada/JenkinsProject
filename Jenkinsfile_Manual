// Jenkinsfile_Manual (para el pipeline regular 'CD_deploy_manual')

pipeline {
    agent any
    
    parameters {
        string(name: 'BRANCH_TO_DEPLOY', defaultValue: 'main', description: 'Selecciona la rama a desplegar: main o dev')
    }

    // Nota: Eliminamos el bloque 'environment' que causaba el error

    stages {
        // Etapa de Despliegue Manual
        stage('Manual Deployment') {
            steps {
                script {
                    echo "Despliegue manual activado para la rama: ${params.BRANCH_TO_DEPLOY}"
                    
                    // 1. Definir variables de Groovy con la lógica condicional
                    def appPort = (params.BRANCH_TO_DEPLOY == 'main') ? '3000' : '3001'
                    def imageName = (params.BRANCH_TO_DEPLOY == 'main') ? 'nodemain:v1.0' : 'nodedev:v1.0'
                    
                    echo "Intentando desplegar ${imageName} en el puerto ${appPort}:3000"
                    
                    // 2. Eliminar contenedores viejos
                    bat "docker rm -f app-manual-${params.BRANCH_TO_DEPLOY} || true"
                    
                    // 3. Desplegar el nuevo contenedor
                    // Usamos las variables Groovy (appPort, imageName) dentro de sh
                    sh "docker run -d --name app-manual-${params.BRANCH_TO_DEPLOY} -p ${appPort}:3000 ${imageName}"
                    
                    echo "Aplicación desplegada manualmente en http://localhost:${appPort}"
                }
            }
        }
    }
}